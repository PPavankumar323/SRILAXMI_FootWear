import { state } from '../utils/state.js';
import { supabase } from '../utils/supabase.js';
import { router } from '../utils/router.js';

export async function renderAdminPage() {
  if (state.userProfile?.role !== 'admin') {
    router.navigate('/');
    return `<div class="container loading">Access Denied. Redirecting...</div>`;
  }

  const [{ count: productCount }, { count: orderCount }, { data: ordersData }, { data: productsData }] = await Promise.all([
    supabase.from('products').select('*', { count: 'exact', head: true }),
    supabase.from('orders').select('*', { count: 'exact', head: true }),
    supabase.from('orders').select('total_amount, created_at').order('created_at', { ascending: false }),
    supabase.from('products').select('*, categories(name), brands(name)').order('created_at', { ascending: false })
  ]);

  const today = new Date();
  today.setHours(0, 0, 0, 0);

  const todayOrders = (ordersData || []).filter(o => new Date(o.created_at) >= today);
  const totalRevenue = (ordersData || []).reduce((sum, o) => sum + o.total_amount, 0);
  const products = (productsData || []).map(p => ({ ...p, category: p.categories?.name || 'N/A', brand: p.brands?.name || 'N/A' }));

  return `
    <div class="container">
      <div style="background: linear-gradient(135deg, var(--primary-color), var(--primary-dark)); color: white; padding: 40px; border-radius: 8px; margin: 24px 0;">
        <h1 style="font-size: 32px; font-weight: 700; margin-bottom: 8px;">Admin Dashboard</h1>
        <p style="opacity: 0.9;">SRI LAXMI FOOT WEAR - Management Portal</p>
      </div>
      
      <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 40px;">
        <div class="main-content" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;"><div style="font-size: 14px; opacity: 0.9; margin-bottom: 8px;">Total Products</div><div style="font-size: 36px; font-weight: 700;">${productCount || 0}</div></div>
        <div class="main-content" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white;"><div style="font-size: 14px; opacity: 0.9; margin-bottom: 8px;">Total Orders</div><div style="font-size: 36px; font-weight: 700;">${orderCount || 0}</div></div>
        <div class="main-content" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); color: white;"><div style="font-size: 14px; opacity: 0.9; margin-bottom: 8px;">Today's Orders</div><div style="font-size: 36px; font-weight: 700;">${todayOrders.length}</div></div>
        <div class="main-content" style="background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%); color: white;"><div style="font-size: 14px; opacity: 0.9; margin-bottom: 8px;">Total Revenue</div><div style="font-size: 36px; font-weight: 700;">â‚¹${(totalRevenue / 1000).toFixed(1)}K</div></div>
      </div>
      
      <div style="display: grid; grid-template-columns: 250px 1fr; gap: 24px;">
        <div class="filters-sidebar">
          <h3 style="font-size: 16px; font-weight: 600; margin-bottom: 16px;">Admin Menu</h3>
          <div style="display: flex; flex-direction: column; gap: 4px;">
            <a href="/admin?tab=products" data-link class="nav-link" style="padding: 12px; border-radius: 4px;">ğŸ“¦ Products</a>
            <a href="/admin?tab=orders" data-link class="nav-link" style="padding: 12px; border-radius: 4px;">ğŸ›ï¸ Orders</a>
            <a href="/admin?tab=customers" data-link class="nav-link" style="padding: 12px; border-radius: 4px;">ğŸ‘¥ Customers</a>
            <a href="/admin?tab=inventory" data-link class="nav-link" style="padding: 12px; border-radius: 4px;">ğŸ“Š Inventory</a>
            <a href="/admin?tab=coupons" data-link class="nav-link" style="padding: 12px; border-radius: 4px;">ğŸŸï¸ Coupons</a>
            <a href="/admin?tab=settings" data-link class="nav-link" style="padding: 12px; border-radius: 4px;">âš™ï¸ Settings</a>
          </div>
        </div>
        
        <div class="main-content">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
            <h2 style="font-size: 24px; font-weight: 600;">Products Management</h2>
            <button class="btn btn-primary" id="add-product-btn">+ Add New Product</button>
          </div>
          <div style="margin-bottom: 20px;"><input type="text" class="search-input" placeholder="Search products..." style="width: 100%;" /></div>
          <div style="overflow-x: auto;">
            <table style="width: 100%; border-collapse: collapse;">
              <thead>
                <tr style="background: var(--bg-light); border-bottom: 2px solid var(--border-color);">
                  <th style="padding: 12px; text-align: left; font-weight: 600;">Product</th>
                  <th style="padding: 12px; text-align: left; font-weight: 600;">Category</th>
                  <th style="padding: 12px; text-align: left; font-weight: 600;">Price</th>
                  <th style="padding: 12px; text-align: left; font-weight: 600;">Stock</th>
                  <th style="padding: 12px; text-align: left; font-weight: 600;">Status</th>
                  <th style="padding: 12px; text-align: left; font-weight: 600;">Actions</th>
                </tr>
              </thead>
              <tbody>
                ${products.length > 0 ? products.map(product => `
                  <tr style="border-bottom: 1px solid var(--border-color);">
                    <td style="padding: 12px;"><div style="display: flex; align-items: center; gap: 12px;"><img src="${product.image}" alt="${product.name}" style="width: 50px; height: 50px; object-fit: cover; border-radius: 4px;" /><div><div style="font-weight: 500; font-size: 14px;">${product.name}</div><div style="font-size: 12px; color: var(--text-secondary);">${product.brand}</div></div></div></td>
                    <td style="padding: 12px;"><span style="padding: 4px 8px; background: var(--bg-light); border-radius: 4px; font-size: 12px;">${product.category}</span></td>
                    <td style="padding: 12px; font-weight: 600;">â‚¹${product.price.toFixed(2)}</td>
                    <td style="padding: 12px;"><span style="color: ${product.stock > 20 ? 'var(--success-color)' : product.stock > 5 ? 'var(--secondary-color)' : 'var(--danger-color)'}; font-weight: 500;">${product.stock}</span></td>
                    <td style="padding: 12px;"><span style="padding: 4px 8px; background: ${product.inStock ? 'var(--success-color)' : 'var(--danger-color)'}; color: white; border-radius: 4px; font-size: 11px; font-weight: 600;">${product.inStock ? 'In Stock' : 'Out of Stock'}</span></td>
                    <td style="padding: 12px;"><div style="display: flex; gap: 8px;"><button class="btn btn-outline edit-product-btn" data-id="${product.id}" style="font-size: 12px; padding: 6px 12px;">Edit</button><button class="btn btn-outline delete-product-btn" data-id="${product.id}" style="font-size: 12px; padding: 6px 12px; color: var(--danger-color);">Delete</button></div></td>
                  </tr>
                `).join('') : `<tr><td colspan="6" style="text-align: center; padding: 40px;">No products found.</td></tr>`}
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  `;
}
